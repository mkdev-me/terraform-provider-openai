name: Acceptance Tests

# Run when:
# 1. Manually triggered (workflow_dispatch)
# 2. PR has 'run-acceptance-tests' label
on:
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter pattern (e.g., TestAccResourceOpenAIVectorStoreFile)'
        required: false
        default: 'TestAcc'
  pull_request:
    types: [labeled]

jobs:
  acceptance-tests:
    # Only run if:
    # - Manual trigger, OR
    # - Has 'run-acceptance-tests' label
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-acceptance-tests'))

    runs-on: ubuntu-24.04
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.12.*'
          terraform_wrapper: false

      - name: Download dependencies
        run: go mod download

      - name: Run acceptance tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # OPENAI_ORGANIZATION_ID is optional for personal accounts
          OPENAI_ORGANIZATION_ID: ${{ secrets.OPENAI_ORGANIZATION_ID }}
          TF_ACC: '1'
          TEST_FILTER: ${{ github.event.inputs.test_filter || 'TestAcc' }}
        run: |
          echo "⚠️  WARNING: Acceptance tests create real resources in OpenAI (costs money)"
          echo "Resources are automatically destroyed after tests complete"
          echo "Running acceptance tests with filter: $TEST_FILTER"
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "Error: OPENAI_API_KEY secret not configured"
            exit 1
          fi
          if [ -z "$OPENAI_ORGANIZATION_ID" ]; then
            echo "Warning: OPENAI_ORGANIZATION_ID not set - using personal account"
          fi
          go test -v -timeout 30m ./internal/provider -run "$TEST_FILTER"

      - name: Comment on PR (on failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Acceptance tests failed. Please check the logs for details.'
            })

      - name: Comment on PR (on success)
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ Acceptance tests passed successfully!'
            })
